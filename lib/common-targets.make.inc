generate-container-conf:
	echo "Generated $(CONTAINER_CONF_GENERATED_FILE) from $(CONTAINER_CONF_JSONNET_TMPL)"
	jsonnet --jpath $(CAF_HOME) --jpath $(CONTAINER_DEFN_HOME) \
			--ext-str GENERATED_ON="`date`" \
			--ext-str DOCKER_HOST_IP_ADDR=$(DOCKER_HOST_IP_ADDR) \
			--ext-str CAF_HOME=$(CAF_HOME) \
			--ext-str APPLIANCE_HOME=$(APPLIANCE_HOME) \
			--ext-str IS_SUBMODULE=$(IS_SUBMODULE) \
	        --ext-str containerName=$(CONTAINER_NAME) \
	        --ext-str defaultNetworkName=$(DOCKER_NETWORK_NAME) \
			--ext-str containerDefnHome=$(CONTAINER_DEFN_HOME) \
			--ext-str currentUserName=$(CURRENT_USER) \
			--ext-str currentUserId=$(CURRENT_USER_ID) \
			--ext-str currentUserGroupId=$(CURRENT_USER_GROUP_ID) \
			--ext-str currentUserHome=$(CURRENT_USER_HOME) \
			--output-file $(CONTAINER_CONF_GENERATED_FILE) \
			$(CONTAINER_CONF_JSONNET_TMPL)
	echo "Generated container definitions from $(CONTAINER_DEFN_JSONNET) (stored in $(CONTAINER_DEFN_JSONNET_GENERATED_FILES_LIST)):"
	jsonnet --jpath $(CAF_HOME) --jpath $(CONTAINER_DEFN_HOME) --multi . $(CONTAINER_DEFN_JSONNET) > $(CONTAINER_DEFN_JSONNET_GENERATED_FILES_LIST)
	cat $(CONTAINER_DEFN_JSONNET_GENERATED_FILES_LIST)  | sed 's/^\.\//  > /'
	echo "Created .gitignore to prevent tracking of generated files"
	echo $(CONTAINER_CONF_GENERATED_FILE) > .gitignore
	echo $(CONTAINER_DEFN_JSONNET_GENERATED_FILES_LIST) >> .gitignore
	cat $(CONTAINER_DEFN_JSONNET_GENERATED_FILES_LIST) | sed 's/^\.\///' >> .gitignore

$(DOCKER_COMPOSE_YAML):
	echo "Validated $(DOCKER_COMPOSE_YAML)"
	docker-compose config --quiet

## Clean the files that were generated by generate-container-conf target
clean-generate-container-conf:
	echo "Deleted $(CONTAINER_CONF_GENERATED_FILE), generated from $(CONTAINER_CONF_JSONNET_TMPL)"
	rm -f $(CONTAINER_CONF_GENERATED_FILE)
	$(CAF_LIB)/delete-files-in-list.sh $(CONTAINER_DEFN_JSONNET_GENERATED_FILES_LIST)
	echo "Deleted $(CONTAINER_DEFN_JSONNET_GENERATED_FILES_LIST)"
	rm -f $(CONTAINER_DEFN_JSONNET_GENERATED_FILES_LIST)

TARGET_MAX_CHAR_NUM=10
# All targets should have a ## Help text above the target and they'll be automatically collected
# Show help, using auto generator from https://gist.github.com/prwhite/8168133
help: generate-container-conf
	@echo ''
	@echo 'Usage:'
	@echo '  ${YELLOW}make${RESET} ${GREEN}<target>${RESET}'
	@echo ''
	@echo 'Targets:'
	@awk '/^[a-zA-Z\-\_0-9]+:/ { \
		helpMessage = match(lastLine, /^## (.*)/); \
		if (helpMessage) { \
			helpCommand = substr($$1, 0, index($$1, ":")-1); \
			helpMessage = substr(lastLine, RSTART + 3, RLENGTH); \
			printf "  ${YELLOW}%-$(TARGET_MAX_CHAR_NUM)s${RESET} ${GREEN}%s${RESET}\n", helpCommand, helpMessage; \
		} \
	} \
	{ lastLine = $$0 }' $(MAKEFILE_LIST)
	@echo ''
	@echo '$(CONTAINER_CONF_GENERATED_FILE):'
	cat $(CONTAINER_CONF_GENERATED_FILE)
